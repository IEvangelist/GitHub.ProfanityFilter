using IEvangelist.GitHub.Services.Extensions;
using IEvangelist.GitHub.Services.Handlers;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using System;
using System.Threading.Tasks;

namespace IEvangelist.GitHub.Sandbox
{
    class Program
    {
        static IServiceProvider _serviceProvider;

        static async Task Main(string[] args)
        {
            try
            {
                RegisterServices();

                var handler = _serviceProvider.GetService<IIssueHandler>();
                await handler.HandleIssueAsync(null);
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message);
            }
            finally
            {
                DisposeServices();
            }
        }

        static void RegisterServices()
        {
            var configBuilder = new ConfigurationBuilder().AddEnvironmentVariables();
            var configuration = configBuilder.Build();
            var services = new ServiceCollection().AddGitHubServices(configuration);

            _serviceProvider = services.BuildServiceProvider();
        }

        static void DisposeServices() => (_serviceProvider as IDisposable)?.Dispose();

        const string IssueJsonPayload = @"{""action"":""edited"",""issue"":{""url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/issues/1"",""repository_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter"",""labels_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/issues/1/labels{/name}"",""comments_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/issues/1/comments"",""events_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/issues/1/events"",""html_url"":""https://github.com/IEvangelist/GitHub.ProfanityFilter/issues/1"",""id"":487247937,""node_id"":""MDU6SXNzdWU0ODcyNDc5Mzc="",""number"":1,""title"":""Fuck this project"",""user"":{""login"":""IEvangelist"",""id"":7679720,""node_id"":""MDQ6VXNlcjc2Nzk3MjA="",""avatar_url"":""https://avatars0.githubusercontent.com/u/7679720?v=4"",""gravatar_id"":"""",""url"":""https://api.github.com/users/IEvangelist"",""html_url"":""https://github.com/IEvangelist"",""followers_url"":""https://api.github.com/users/IEvangelist/followers"",""following_url"":""https://api.github.com/users/IEvangelist/following{/other_user}"",""gists_url"":""https://api.github.com/users/IEvangelist/gists{/gist_id}"",""starred_url"":""https://api.github.com/users/IEvangelist/starred{/owner}{/repo}"",""subscriptions_url"":""https://api.github.com/users/IEvangelist/subscriptions"",""organizations_url"":""https://api.github.com/users/IEvangelist/orgs"",""repos_url"":""https://api.github.com/users/IEvangelist/repos"",""events_url"":""https://api.github.com/users/IEvangelist/events{/privacy}"",""received_events_url"":""https://api.github.com/users/IEvangelist/received_events"",""type"":""User"",""site_admin"":false},""labels"":[],""state"":""open"",""locked"":false,""assignee"":null,""assignees"":[],""milestone"":null,""comments"":0,""created_at"":""2019-08-30T01:58:22Z"",""updated_at"":""2019-08-30T13:08:51Z"",""closed_at"":null,""author_association"":""OWNER"",""body"":""I think it's completely bullshit - this must not work? It's so fucked up... fuck this shit 👎  I can't believe it's not working. God damnit""},""changes"":{""body"":{""from"":""I think it's completely bullshit - this must not work? It's so fucked up... fuck this shit 👎  I can't believe it's not working.""}},""repository"":{""id"":205049285,""node_id"":""MDEwOlJlcG9zaXRvcnkyMDUwNDkyODU="",""name"":""GitHub.ProfanityFilter"",""full_name"":""IEvangelist/GitHub.ProfanityFilter"",""private"":false,""owner"":{""login"":""IEvangelist"",""id"":7679720,""node_id"":""MDQ6VXNlcjc2Nzk3MjA="",""avatar_url"":""https://avatars0.githubusercontent.com/u/7679720?v=4"",""gravatar_id"":"""",""url"":""https://api.github.com/users/IEvangelist"",""html_url"":""https://github.com/IEvangelist"",""followers_url"":""https://api.github.com/users/IEvangelist/followers"",""following_url"":""https://api.github.com/users/IEvangelist/following{/other_user}"",""gists_url"":""https://api.github.com/users/IEvangelist/gists{/gist_id}"",""starred_url"":""https://api.github.com/users/IEvangelist/starred{/owner}{/repo}"",""subscriptions_url"":""https://api.github.com/users/IEvangelist/subscriptions"",""organizations_url"":""https://api.github.com/users/IEvangelist/orgs"",""repos_url"":""https://api.github.com/users/IEvangelist/repos"",""events_url"":""https://api.github.com/users/IEvangelist/events{/privacy}"",""received_events_url"":""https://api.github.com/users/IEvangelist/received_events"",""type"":""User"",""site_admin"":false},""html_url"":""https://github.com/IEvangelist/GitHub.ProfanityFilter"",""description"":""An Azure function to handle a GitHub webhook, which will take action on issues/pull requests that contain profanity."",""fork"":false,""url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter"",""forks_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/forks"",""keys_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/keys{/key_id}"",""collaborators_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/collaborators{/collaborator}"",""teams_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/teams"",""hooks_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/hooks"",""issue_events_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/issues/events{/number}"",""events_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/events"",""assignees_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/assignees{/user}"",""branches_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/branches{/branch}"",""tags_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/tags"",""blobs_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/git/blobs{/sha}"",""git_tags_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/git/tags{/sha}"",""git_refs_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/git/refs{/sha}"",""trees_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/git/trees{/sha}"",""statuses_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/statuses/{sha}"",""languages_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/languages"",""stargazers_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/stargazers"",""contributors_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/contributors"",""subscribers_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/subscribers"",""subscription_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/subscription"",""commits_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/commits{/sha}"",""git_commits_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/git/commits{/sha}"",""comments_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/comments{/number}"",""issue_comment_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/issues/comments{/number}"",""contents_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/contents/{+path}"",""compare_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/compare/{base}...{head}"",""merges_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/merges"",""archive_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/{archive_format}{/ref}"",""downloads_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/downloads"",""issues_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/issues{/number}"",""pulls_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/pulls{/number}"",""milestones_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/milestones{/number}"",""notifications_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/notifications{?since,all,participating}"",""labels_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/labels{/name}"",""releases_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/releases{/id}"",""deployments_url"":""https://api.github.com/repos/IEvangelist/GitHub.ProfanityFilter/deployments"",""created_at"":""2019-08-29T00:43:38Z"",""updated_at"":""2019-08-29T14:01:35Z"",""pushed_at"":""2019-08-29T01:05:12Z"",""git_url"":""git://github.com/IEvangelist/GitHub.ProfanityFilter.git"",""ssh_url"":""git@github.com:IEvangelist/GitHub.ProfanityFilter.git"",""clone_url"":""https://github.com/IEvangelist/GitHub.ProfanityFilter.git"",""svn_url"":""https://github.com/IEvangelist/GitHub.ProfanityFilter"",""homepage"":"""",""size"":18,""stargazers_count"":0,""watchers_count"":0,""language"":""C#"",""has_issues"":true,""has_projects"":true,""has_downloads"":true,""has_wiki"":true,""has_pages"":false,""forks_count"":0,""mirror_url"":null,""archived"":false,""disabled"":false,""open_issues_count"":1,""license"":null,""forks"":0,""open_issues"":1,""watchers"":0,""default_branch"":""master""},""sender"":{""login"":""IEvangelist"",""id"":7679720,""node_id"":""MDQ6VXNlcjc2Nzk3MjA="",""avatar_url"":""https://avatars0.githubusercontent.com/u/7679720?v=4"",""gravatar_id"":"""",""url"":""https://api.github.com/users/IEvangelist"",""html_url"":""https://github.com/IEvangelist"",""followers_url"":""https://api.github.com/users/IEvangelist/followers"",""following_url"":""https://api.github.com/users/IEvangelist/following{/other_user}"",""gists_url"":""https://api.github.com/users/IEvangelist/gists{/gist_id}"",""starred_url"":""https://api.github.com/users/IEvangelist/starred{/owner}{/repo}"",""subscriptions_url"":""https://api.github.com/users/IEvangelist/subscriptions"",""organizations_url"":""https://api.github.com/users/IEvangelist/orgs"",""repos_url"":""https://api.github.com/users/IEvangelist/repos"",""events_url"":""https://api.github.com/users/IEvangelist/events{/privacy}"",""received_events_url"":""https://api.github.com/users/IEvangelist/received_events"",""type"":""User"",""site_admin"":false}}";
    }
}